# 项目技术原理说明

## 1. 项目概述

本项目是一个**静态 HTML 转 Android APK** 的自动化构建工具。它不依赖 Android Studio 等庞大的 IDE，而是直接调用 Android SDK Build-tools 底层命令行工具，通过 Python 脚本串联整个构建流程，实现轻量级、快速打包。

## 2. 核心技术栈与工具

### 2.1 编程语言与环境

* **Python 3**: 控制构建逻辑、文件处理、正则替换和子进程调用。
* **Java Development Kit (JDK) 1.8+**: 用于编译 Java 代码和生成密钥库。

### 2.2 Android SDK Build-tools

构建过程直接调用了以下底层工具：

* **aapt (Android Asset Packaging Tool)**: 处理资源文件（AndroidManifest.xml, assets, res），生成 APK 包结构。
* **d8 (DEX 编译器)**: 将编译后的 Java `.class` 字节码转换为 Android 专用的 `.dex` (Dalvik Executable) 文件。
* **zipalign**: 对 APK 进行字节对齐优化，提高运行时的内存映射效率。
* **apksigner**: 对最终 APK 进行 V2/V3 签名，确保安装安全性。

### 2.3 其他工具

* **javac**: Java 编译器，将 `.java` 源码编译为 `.class` 文件。
* **keytool**: 生成 Java Keystore (JKS) 签名证书。
* **Pillow (Python库)**: 图像处理库，用于将用户提供的图标自动缩放为 Android 所需的各种尺寸（mipmap/drawable）。

## 3. 自动化构建流程详解

构建脚本 `build_apk.py` 的执行流程如下：

### 第一步：环境检查与配置解析

1. 加载 `args.yaml` 配置文件或解析命令行参数。
2. 自动探测 `ANDROID_HOME` 环境变量，定位 `aapt`, `d8`, `android.jar` 等关键文件路径。

### 第二步：资源准备

1. **Manifest 处理**: 读取 `android_shell` 中的模板 `AndroidManifest.xml`，动态注入/替换：
    * 包名 (`package`)
    * 应用名称 (`android:label`)
    * 版本号 (`android:versionName`)
    * 权限 (`<uses-permission>`, `<uses-sdk>`)
    * 图标引用 (`android:icon`)
    * 主题样式 (`android:theme`)
2. **Web 资源复制**: 将指定的 HTML 文件复制到 `assets/www/index.html`。
3. **图标生成**: 使用 Pillow 将源图标调整为多种分辨率（mdpi 到 xxxhdpi），存入 `res/mipmap-*` 或 `res/drawable-*` 目录。
4. **样式生成**: 动态生成 `res/values/styles.xml`，配置应用主题（如去除 ActionBar，设置启动背景色），优化启动体验。

### 第三步：代码编译 (Java -> DEX)

1. **Java 编译**: 调用 `javac` 编译 `MainActivity.java`。
    * *原理*: `MainActivity` 是一个原生 Activity，内部实例化一个 `WebView` 控件，配置 WebSettings（启用 JavaScript、DOM Storage），并加载 `file:///android_asset/www/index.html`。
2. **DEX 转换**: 调用 `d8` 将编译生成的 `.class` 文件转换为 `classes.dex`。

### 第四步：打包与合成

1. **资源打包**: 使用 `aapt package` 命令：
    * 编译 `AndroidManifest.xml` 为二进制格式。
    * 打包 `res` 资源和 `assets` 目录。
    * 生成初始的 `unsigned.apk`。
2. **添加代码**: 使用 `aapt add` 将 `classes.dex` 添加到 `unsigned.apk` 根目录。

### 第三步：优化与签名

1. **对齐优化**: 使用 `zipalign -p 4` 对 APK 进行 4 字节对齐。
2. **证书检查**: 检查 `build/debug-jks.keystore` 是否存在，若不存在则调用 `keytool` 自动生成一个调试证书（JKS 格式，RSA 2048位）。
3. **应用签名**: 使用 `apksigner` 对齐后的 APK 进行签名，生成最终的可安装包。

## 4. 目录结构说明

```text
App_generate/
├── android_shell/              # Java 源码壳工程
│   ├── app/src/main/
│   │   ├── AndroidManifest.xml # 清单文件模板
│   │   └── java/.../MainActivity.java  # WebView 容器源码
├── build_apk.py                # 核心构建脚本
├── args.yaml                   # 构建参数配置
├── 技术原理.md                 # 本文档
└── build/                      # 构建输出目录（包含临时文件、密钥库、生成的 APK）
```
